<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
  <head>
    <title>Album</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://universal-editor-service.adobe.io/cors.js" async></script>
    <meta name="urn:adobe:aue:system:aemconnection" content="">
    <script>
      const configMappingObj = {
        'aem-author-url': 'input-aem-author-url',
        'aem-content-fragment-folder-path': 'input-aem-content-fragment-folder-path',
        'aem-image-folder-path': 'input-aem-image-folder-path'
      };

      var configObj = {
        'aem-author-url' : '',
        'aem-content-fragment-folder-path': '',
        'aem-image-folder-path': ''
      };

      function saveConfigInModal() {
        Object.entries(configMappingObj).forEach(([key, value]) => {
          localStorage.setItem(key, document.getElementById(value).value);
          //console.log(`${key}: ${value}`);
        });

        loadConfig();
      }

      function loadConfigInModal() {
        loadConfig();

        Object.entries(configMappingObj).forEach(([key, value]) => {
          document.getElementById(value).value = localStorage.getItem(key);
          //console.log(`${key}: ${value}`);
        });
      }

      function loadConfig() {
        configObj['aem-author-url'] = localStorage.getItem('aem-author-url');
        configObj['aem-content-fragment-folder-path'] = localStorage.getItem('aem-content-fragment-folder-path');
        configObj['aem-image-folder-path'] = localStorage.getItem('aem-image-folder-path');

        document.querySelector('meta[name="urn:adobe:aue:system:aemconnection"]').content = 'aem:' + localStorage.getItem('aem-author-url');

        renderCarousel();

        renderAlbum();
      }

      function jsx(html, ...args) {
        return html.slice(1).reduce((str, elem, i) => str + args[i] + elem, html[0]);
      }

      function renderAlbum() {
        const AEMURL = configObj['aem-author-url'];
        const AEMImageFolderPath = configObj['aem-image-folder-path'];
        const targetDOM = document.querySelector('.album .container .row');
        targetDOM.innerHTML = '';

        if(!AEMURL) {
          return;
        }

        if(!AEMImageFolderPath) {
          return;
        }

        const sourceUrl = AEMURL + AEMImageFolderPath.replace('/content/dam/', '/api/assets/') + '.json';

        fetch(sourceUrl, {
          method: 'GET',
          credentials: 'include', // Include credentials like cookies
          headers: {
            'Content-Type': 'application/json', // Example custom header
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          var albumHTML = '';

          data.entities.forEach(function(entity, index) {

            switch(entity.properties.metadata['dc:format']) {
              case 'video/mp4':
                albumHTML += jsx`
                  <div class="col">
                    <div class="card shadow-sm">
                      <video controls>
                        <source src="${entity.links[1].href}" type="video/mp4">
                        Your browser does not support the video tag.
                      </video>
                      <div class="card-body">
                        <p class="card-text">${entity.properties.name}</p>
                        <div class="d-flex justify-content-between align-items-center">
                          <small class="text-body-secondary">${entity.properties.metadata['dc:format']}</small>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
                break;
              default:
                albumHTML += jsx`
                  <div class="col">
                    <div class="card shadow-sm">
                      <img class="bd-placeholder-img card-img-top" src="${entity.links[1].href}">
                      <div class="card-body">
                        <p class="card-text">${entity.properties.name}</p>
                        <div class="d-flex justify-content-between align-items-center">
                          <small class="text-body-secondary">${entity.properties.metadata['dc:format']}</small>
                        </div>
                      </div>
                    </div>
                  </div>
                `;
            }
          });

          targetDOM.innerHTML = albumHTML;
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
      }

      function renderCarousel() {
        const AEMURL = configObj['aem-author-url'];
        const AEMContentFragmentFolderPath = configObj['aem-content-fragment-folder-path'];
        const targetDOM = document.querySelector('main section');
        targetDOM.innerHTML = '';

        if(!AEMURL) {
          return;
        }

        if(!AEMContentFragmentFolderPath) {
          return;
        }

        const sourceUrl = AEMURL + '/graphql/execute.json/ref-demo-eds/FetchCTAOfferByPath;folderPath=' + AEMContentFragmentFolderPath;

        fetch(sourceUrl, {
          method: 'GET',
          credentials: 'include', // Include credentials like cookies
          headers: {
            'Content-Type': 'application/json', // Example custom header
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          const carouselID = 'carousel';

          var carouselHTML = `<div id="${carouselID}" class="carousel slide">`;
          var carouselIndicatorsHTML = '<div class="carousel-indicators">';
          var carouselInnersHTML = '<div class="carousel-inner">';

          data.data.ctaList.items.forEach(function(item, index) {
            var cssClass = '';

            if(index == 0) {
              cssClass = 'active';
            }

            carouselIndicatorsHTML += jsx`
              <button type="button" data-bs-target="#${carouselID}" data-bs-slide-to="${index}" class="${cssClass}" aria-current="true" aria-label="Slide ${index + 1}"></button>
            `;

            carouselInnersHTML += jsx`
              <div class="carousel-item ${cssClass}" data-aue-type="${item.__typename}" data-aue-resource="urn:aemconnection:${item._path}/jcr:content/data/${item._variation}">
                <img src="${item.bannerimage._authorUrl}" class="d-block w-100" alt="${item.title}">
                <div class="carousel-caption bg-dark bg-opacity-75 d-none d-md-block">
                  <h5>${item.subtitle}</h5>
                  <p>${item.description.plaintext}</p>
                </div>
              </div>
            `;
          });

          carouselIndicatorsHTML += '</div>';
          carouselInnersHTML += '</div>';

          carouselHTML += carouselIndicatorsHTML;
          carouselHTML += carouselInnersHTML;

          carouselHTML += jsx`
            <button class="carousel-control-prev" type="button" data-bs-target="#${carouselID}" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#${carouselID}" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          `;

          carouselHTML += '</div>';

          targetDOM.innerHTML = carouselHTML;
        })
        .catch(error => {
          console.error('Error fetching data:', error);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('configModal').addEventListener('show.bs.modal', event => {
          loadConfigInModal();
        });

        loadConfigInModal();
      });
    </script>
  </head>
  <body>
    <div class="dropdown position-fixed bottom-0 end-0 mb-3 me-3 bd-mode-toggle">
      <button class="btn btn-bd-primary py-2 dropdown-toggle d-flex align-items-center" id="bd-theme" type="button" aria-expanded="false" data-bs-toggle="dropdown" aria-label="Toggle theme (auto)">
        <svg class="bi my-1 theme-icon-active" aria-hidden="true">
          <use href="#circle-half"></use>
        </svg>
        <span class="visually-hidden" id="bd-theme-text">Toggle theme</span>
      </button>
      <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="bd-theme-text">
        <li>
          <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
            <svg class="bi me-2 opacity-50" aria-hidden="true">
              <use href="#sun-fill"></use>
            </svg> Light <svg class="bi ms-auto d-none" aria-hidden="true">
              <use href="#check2"></use>
            </svg>
          </button>
        </li>
        <li>
          <button type="button" class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="false">
            <svg class="bi me-2 opacity-50" aria-hidden="true">
              <use href="#moon-stars-fill"></use>
            </svg> Dark <svg class="bi ms-auto d-none" aria-hidden="true">
              <use href="#check2"></use>
            </svg>
          </button>
        </li>
        <li>
          <button type="button" class="dropdown-item d-flex align-items-center active" data-bs-theme-value="auto" aria-pressed="true">
            <svg class="bi me-2 opacity-50" aria-hidden="true">
              <use href="#circle-half"></use>
            </svg> Auto <svg class="bi ms-auto d-none" aria-hidden="true">
              <use href="#check2"></use>
            </svg>
          </button>
        </li>
      </ul>
    </div>
    <header data-bs-theme="dark">
      <div class="collapse text-bg-dark" id="navbarHeader">
        <div class="container">
          <div class="row">
            <div class="col-sm-8 col-md-7 py-4">
              <h4>About</h4>
              <p class="text-body-secondary">Add some information about the album below, the author, or any other background context. Make it a few sentences long so folks can pick up some informative tidbits. Then, link them off to some social networking sites or contact information.</p>
            </div>
            <div class="col-sm-4 offset-md-1 py-4">
              <h4>Contact</h4>
              <ul class="list-unstyled">
                <li>
                  <a href="#" class="text-white">Follow on X</a>
                </li>
                <li>
                  <a href="#" class="text-white">Like on Facebook</a>
                </li>
                <li>
                  <a href="#" class="text-white">Email me</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">
          <a href="#" data-bs-toggle="modal" data-bs-target="#configModal" class="navbar-brand d-flex align-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true" class="me-2" viewBox="0 0 24 24">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
              <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <strong>Config Album</strong>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </div>
    </header>
    <main>
      <section class="py-5 container">
        <!-- <div class="row py-lg-5"> -->
        <!-- </div> -->
      </section>
      <div class="modal fade modal-lg" id="configModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Configurations</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="input-aem-author-url"" class="form-label">AEM Author URL</label>
                <input type="email" class="form-control" id="input-aem-author-url"" placeholder="https://author-p7716-e868301.adobeaemcloud.com">
              </div>
              <div class="mb-3">
                <label for="input-aem-content-fragment-folder-path" class="form-label">Content Fragment Folder Path</label>
                <div class="input-group">
                  <input type="email" class="form-control" id="input-aem-content-fragment-folder-path" placeholder="/content/dam/ref-demo-eds/en/fragments/promotions">
                  <div class="input-group-append">
                    <button type="button" class="btn btn-secondary">Select</button>
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="input-aem-image-folder-path" class="form-label">Image Folder Path</label>
                <div class="input-group">
                  <input type="email" class="form-control" id="input-aem-image-folder-path" placeholder="/dam/ref-demo-eds/en/adventures">
                  <div class="input-group-append">
                    <button type="button" class="btn btn-secondary">Select</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="saveConfigInModal()">Save changes</button>
            </div>
          </div>
        </div>
      </div>
      <div class="album py-5 bg-body-tertiary">
        <div class="container">
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
          </div>
        </div>
      </div>
    </main>
    <footer class="text-body-secondary py-5">
      <div class="container">
        <p class="float-end mb-1">
          <a href="#">Back to top</a>
        </p>
        <p class="mb-1">Album example is &copy; Bootstrap, but please download and customize it for yourself!</p>
        <p class="mb-0">New to Bootstrap? <a href="/">Visit the homepage</a> or read our <a href="/docs/5.3/getting-started/introduction">getting started guide</a>. </p>
      </div>
    </footer>
  </body>
</html>
